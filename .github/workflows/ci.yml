name: Node.js CI Unix Platform

on: [push, pull_request]

jobs:
  test:
    environment: test # for secrets
    timeout-minutes: 30
    strategy:
      matrix:
        node-version:
          - node/10
          - node/12
          - node/14
          - node/15
          - node/16
        compiler:
          - gcc
          - clang
        os:
          - ubuntu-16.04 # ubuntu-18.04/ubuntu-latest missing package g++-4.9
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v2
    - name: Install system dependencies
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" -a "${{ matrix.os }}" = ubuntu-* ]; then
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install g++-4.9
        fi
        if [ "$COLLECT_COVERAGE" == "true" ]; then
          gem install --user coveralls-lcov
          sudo apt-get install -y lcov
        fi
      env:
        COLLECT_COVERAGE: ${{ format('{0}-{1}-{2}', matrix.node-version, matrix.compiler, matrix.os) == 'node/16-gcc-ubuntu-16.04' }}
    - name: Use Node.js ${{ matrix.node-version }}
      run: |
        git clone --branch v1.4.2 --depth 1 https://github.com/jasongin/nvs ~/.nvs
        . ~/.nvs/nvs.sh
        nvs --version
        nvs add ${{ matrix.node-version }}
        nvs use ${{ matrix.node-version }}
        node --version
        npm --version
        npm install
    - name: npm test
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          export CC="gcc" CXX="g++"
        fi
        if [ "${{ matrix.compiler }}" = "gcc" -a "${{ matrix.os }}" = ubuntu-* ]; then
          export CC="gcc-4.9" CXX="g++-4.9" AR="gcc-ar-4.9" RANLIB="gcc-ranlib-4.9" NM="gcc-nm-4.9"
        fi
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          export CC="clang" CXX="clang++"
        fi
        if [ "$COLLECT_COVERAGE" == "true" ]; then
          export CFLAGS="$CFLAGS -O0 --coverage" CXXFLAGS="$CXXFLAGS -O0 --coverage" LDFLAGS="$LDFLAGS --coverage"
        else
          export CFLAGS="$CFLAGS -O3" CXXFLAGS="$CXXFLAGS -O3"
        fi
        echo "CFLAGS=\"$CFLAGS\" CXXFLAGS=\"$CXXFLAGS\" LDFLAGS=\"$LDFLAGS\""
        npm run pretest -- --verbose
        node test/date.js
      env:
        COLLECT_COVERAGE: ${{ format('{0}-{1}-{2}', matrix.node-version, matrix.compiler, matrix.os) == 'node/16-gcc-ubuntu-16.04' }}
    - name: Upload coverage
      if: ${{ format('{0}-{1}-{2}', matrix.node-version, matrix.compiler, matrix.os) == 'node/16-gcc-ubuntu-16.04' }}
      run: |
        BUILD_TYPE=$(node -p "process.config.target_defaults.default_configuration")
        GEM_HOME="$(ruby -e 'puts Gem.user_dir')"
        lcov --capture --directory test/build/$BUILD_TYPE/obj.target/ --output-file test/build/$BUILD_TYPE/coverage.info
        lcov --remove test/build/$BUILD_TYPE/coverage.info '/usr/include/*' 'test/*' -o test/build/$BUILD_TYPE/coverage-filtered.info
        $GEM_HOME/bin/coveralls-lcov test/build/$BUILD_TYPE/coverage-filtered.info --repo-token $COVERALLS_REPO_TOKEN
      env:
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
